<HTML>
<HEAD>
<TITLE>Tutorial - Deploying an Application</TITLE>
</HEAD>

<BODY>

<A NOPRINT HREF="tut_6.html"> <IMG SRC="../../icons/DocsLeftArrow.gif" ALT="[prev]"></A>
<A NOPRINT HREF="tutorial.html">   <IMG SRC="../../icons/DocsUpArrow.gif" ALT="[up]"></A>
<A NOPRINT HREF="tut_7b.html"> <IMG SRC="../../icons/DocsRightArrow.gif" ALT="[next]"></A>

<P>

<B>NOTICE</B>
This chapter - although still valid to some degree - is now mostly obsoleted
by the availability of the packager, which does all of the build process for you.
You may skip this if you are not interested in the details and if you do not intent
to build using a source code repository.


<H1><A NAME="DEPLOYING">Deploying an Application</A></H1>

This document should give you detailed step-by-step instructions to enable
you to manage the almost automatic build process for deployable applications.
Additional information covering the process of application development inside the browser
is found in the <A HREF="../programming/deployment.html">Smalltalk/X Programmer's Guide</A>.
<BR>
If you follow these steps and have everything setup correctly, an automatic build for a deployable,
self installing application will be a matter of minutes.


<H2><A NAME="PREREQUISITES">Before you start: Prerequisites</A></H2>

<UL>

<LI>ST/X Directory Hierarchy
<BR>
Before you start, please check, if you have installed ST/X <B>EXACTLY</B> as in the following tree:
<BLOCKQUOTE><PRE>
...
   stxXXX (where XXX is the ST/X release; currently 542)
      stx
	 ...
	 libbasic
	 ...
	 projects
	    ...
	    smalltalk
	    ...
</PRE></BLOCKQUOTE>
Don't be mislead by the name "projects" - your projects will NOT be stored there (for one: it is for
exept-projects only; second: the name is a historic leftover).
<BR>
Your projects will all end up being located in a single directory BESIDE the "stx" directory.
Do not create any directory under stx, and do not later edit any files there.
These will be under control of ST/X + CVS only. In other words: these are for checkout and build only,
not for code files.
<P>

<LI>Setup CVS (Source Code Versioning System)
<BR>
This is optional; you can work without a version management system,
or even use another one (SVN, Mercurial, Git, etc.).
However, CVS was the first such system supported by ST/X and has
good tool integration, especially in the browser.
<BR>
For now, you have to have a CVS source/code repository running on one of your machines in
the LAN (can be, but does not have to be the local machine).
The CVS should be reachable via the :pserver: protocol.
Unix users will probably already find CVS on their system or at least on their
distribution medium. Windows users have to download one, or run linux on a real
or on a virtual machine. And use that one.
<BR>
As CVS admin user (not within Smalltalk), create a CVS module, with a useful name.
Don't use a stupid name such as "test", "foo" or "demo".
We recommend, using your company, your initials or any other meaningful name.
If you ever want to share your code with other Smalltalkers, it has to be unique to
avoid a conflict. And it will be a lot of stupid, error-prone, manual work to fix this later,
because many files will be automatically generated by ST/X later, which depend on this to
be consistent.
<P>
We are aware of the fact, that CVS is not the best choice, and will both provide support to deploy
using other repositories (concrete: SVN or GIT).
But for now, that's all we have and you have to live with it,
just like we have to ;-)


<P>
<LI>Get a C-Compiler (Windows Users: get the free Borland compiler or Visual-C)
<BR>
Unix users will usually already have gcc installed (to check, type "gcc --version" at a command prompt).
<P>
Windows users will have to either download the free Borland 5.5 command-line tools or the Visual-C compiler
and install either (or both) at the default location.
For bcc, this is "c:\borland\bcc55". Make sure that bcc32 is found along your path by typing "bcc32" into
a command window.
<BR>Also notice, that there have to be two configuration files in the bin directory:
<CODE>"C:\Borland\bcc55\Bin\bcc32.cfg"</CODE> containing 2 lines:
<PRE><CODE>    -I"c:\Borland\Bcc55\include"
    -L"c:\Borland\Bcc55\lib"
</CODE></PRE>
and <CODE>"C:\Borland\bcc55\Bin\ilink32.cfg"</CODE> containing:
<PRE><CODE>    -L"c:\Borland\Bcc55\lib"
</CODE></PRE>
<P>
Without them, bcc-compilations and linkage will fail later (the bcc-installer does not create those files!).
</UL>

<H2><A NAME="CHECK_AGAIN">Check the Prerequisites again</A></H2>
Sorry to bother you again, just to make sure:
<BR>
<H4>Unix Users:</H4>
<BLOCKQUOTE>Open a terminal window (xterm), and type both "cvs" and "gcc --version".
There should be reasonable responses for both (aka: not "command not found").
</BLOCKQUOTE>
<H4>MSDos Users:</H4>
<BR>
<BLOCKQUOTE>Borland-C users should open a command window, and try both "cvs" and "bcc32".
There should be reasonable responses for both.
<P>
In case you use Visual-C, make sure that your shell environment includes
the Visual-C path (VSINSTALLDIR). In a command window, type "echo %VSINSTALLDIR%".
If that value is not set, look for a batch file named "%ProgramFiles%\Microsoft Visual Studio xx.0"\VC\bin\vcvars32.bat",
and execute it (xx is one of "9.0", "10.0" or "11.0"). If required, add a call to that batch file to your "autoexec.bat".
</BLOCKQUOTE>

Sorry again, but now we are sure (too many people wrote emails in the past).


<H2><A NAME="CONNECTING_TO_CVS">Connecting ST/X to CVS</A></H2>

If you don't know anything about CVS,
you should download an introduction from the internet and
learn about CVSRoot, modules and pserver settings.
<BR>Or else, ask a friend.
<P>
Back in Smalltalk, open the <I>"System"</I>-<I>"Settings"</I> dialog in the launcher
and navigate to the "Source Code Management"-settings.
<UL>
<LI>Enable Source Code Management
<LI>Turn on the "Use Local Source (suppress checkout)" checkbox
<LI>Make CVS the "Default Repository Type"
<LI>Navigate to the CVS sub-page (expand the SCM node in the settings tree)
<LI>Enable "Show CVS in Browser Menus"
<LI>specify your own repository-path in the "CVSRoot-default" field
<LI>specify "<CODE>:pserver:cvs@cvs.smalltalk-x.de:/cvs/stx</CODE>" as CVSRoot-per-module for the "stx"-module.
<LI>Apply the changes.
</UL>

Let me explain, what that setting means:
<BR>
defining exept's cvs-pserver for the "stx" module means
that the source for any class <B>under the "stx" project tree</B> should be fetched from the <B>exept sourceCode server</B>.
However, the "Use Local Source" flag tells it to look for a local file under the stx-tree first.
That means, that for all existing classes, the pserver will never be asked, because the sources
are part of the distribution and you should have them on your system.
<P>
The other setting (your own cvs repository as default) means that for <B>all other classes</B>,
your <B>local cvs server</B> should be consultet.

<H3><A NAME="VALIDATE_SETUP">Checking your Setup</A></H3>

To check if CVS access to the public repository from within ST/X works correctly,
open a system browser and navigate to some standard class (for example, "Boolean")
and select the class-list's <I>"Repository"</I>-<I>"Revision Log"</I>  (German: <I>"Info zu Versionen"</I>) menu item.
After some delay, the browser should show the release information from exept's CVS server.
You can also try the "Compare against Version in Repository" menu function, to see what has been
changed relative to an older version of the Boolean class.
<P>
Don't forget to check the "Use Local Source (suppress checkout)" flag in the CVS settings dialog.
If you do forget it, your browser will access the exept CVS repository whenever it needs to show the source of a class or method.
Although the fetched files will be cached (so the slow cvs-access is usually only performce once),
but anyway this can be quite slow and annoying for quite some time,
and is actually totally useless, because all files are already on your machine.
<P>
However, you should never ever modify those source files, if that "use local source"-flag is checked.
If you do, the browser will show garbage, as it trusts the file to contain the method sources at exactly
the position which has been compiled into the binary. That is: the binary only contains the file-offset
position of the source from which it was compiled. Setting the "use local source"-flag tells the source code mangager,
that it shall use those files and NOT ask the CVS repository.
If you ever see garbage source code in the browser (after you accidentically modified your seources), uncheck that flag.


<H2><A NAME="MAKING_PROJECT">Making a Project</A></H2>

<H3><A NAME="PROJECT_HIERARCHY">Specifying the Project's Hierarchy</A></H2>

Back in Smalltalk, open a SystemBrowser and switch the view-mode to "Project" in the main menu.
You should now see a project-hierarchy on the left, instead of the classical
category-view.
<P>
Right-click in the project-list, and select the "New..."-menu item.
<P>
Enter a reasonable package-ID for your own project (in the documentation you will also occasionally read "project-ID" - which is the same).
A package-ID consists of two parts, separated by a colon: the module name and a repository path.
The module component before the colon, MUST be the same
as the name of your CVS-module. The stuff after the colon will be used as the directory path
within the repository. As a rule of thumb, use package-IDs of the form
<BLOCKQUOTE>
<VAR>myOwnTopID</VAR> <B>:</B> <VAR>projectName</VAR> <B>/</B> <VAR>componentName</VAR>  (no spaces in-between)
</BLOCKQUOTE>
Notice that for deployed packages, every class and extension method with the same packageID
will end up being compiled into the same dll.
So if you have debug- and test-classes (unit tests), you'd better put them into
a sub-package, such as: "<VAR>myOwnTopID</VAR>:<VAR>projectName</VAR>/<VAR>componentName</VAR>/test".
<P>
A concrete example would be:
<BLOCKQUOTE><PRE>
theBiggerBugLTD:salesApp/startup
theBiggerBugLTD:salesApp/startup/tests
theBiggerBugLTD:salesApp/gui
theBiggerBugLTD:salesApp/gui/tests
theBiggerBugLTD:salesApp/database/
theBiggerBugLTD:salesApp/database/support
</PRE></BLOCKQUOTE>
Just to give you a rough idea. Use common sense and your experience.


<H3><A NAME="ASSIGN_PROJECTS_TO_CLASSES">Move Classes into the Hierarchy</A></H2>

Next, all of your code should be moved to the appropriate place in the project/package hierarchy.
This can be done in the System Browser either via drag & drop (by moving a class or group of classes over to the package),
or by selecting the class(es) and applying the class-list menu function "<VAR>Move</VAR>"-"<VAR>To Package...</VAR>".
<P>
If your application requires extension methods (that is: extensions to other classes),
these must be assigned to the corresponding package as well. For example, if you have
added a method for the <CODE>String</CODE> class, which is required by your application,
move that to the appropriate package as well (there is a "<VAR>Move</VAR>"-"<VAR>To Package...</VAR>" also found
in the browser's method-list menu).
<P>
Don't forget the above step and don't try the stx project.
If you do, the checkin operation below will try to check your classes into our exept repository.
That will certainly fail, because what you reach there is a passive read-only copy of our real repository.
Beside being read/only, it will also be overwritten when the next copy is made - typically the next night.


<H2><A NAME="PROJECT_DEFINITION">Adding a Project Definition</A></H2>

Next, we need to update or create a so-called "<VAR>Project Definitions</VAR>".
These are classes which specify the contents and attributes of a project,
and also how they are to be processed during the build.
As a class, each project definition is also
part of the package and is also compiled into the dll.
So all the information is again automatically included and present,
when the generated dll is eventually loaded into another Smalltalk.
<P>
If you created the project as described above, you should already see those project definitons
in the browser's project-tree. If not, it is now time to do it.
<P>
Then, have a look at the code as present so far (it is all found on the class-protocol side).
<P>
Some of these can be regenerated via class-lists menu items "<VAR>Generate</VAR>"-"<VAR>Project Definition</VAR>"
and "<VAR>Generate</VAR>"-"<VAR>Update Project Contents Definition</VAR>"
and also "<VAR>Generate</VAR>"-"<VAR>Regenerate Project Contents Definition</VAR>".
(They differ on how they deal with existing code, and which definitons are regenerated.
For now, only use the "<VAR>Update</VAR>" function, and edit the rest by hand.
<P>
Notice that the generated prerequisite list only includes packages of classes which are seen by a static code
analysis - if you construct class names dynamically, you should add the names of the corresponding
packages manually to the list.
If you update the list via the generator later, only new entries will be added.
If you "regenerate", you have to repeat your additions.
<BR>
If the prerequisite generator adds packages for which you are absolutely sure that they are not needed (for example: testcases),
add a method named "<CODE>excludedFromPreRequisites</CODE>" and list those packages there.
<P>
If in doubt, use the browser and look at existing project-description classes as a guide - they are pretty easy to understand.

<H4>Library Descriptions vs. Application Descriptions</H4>

There are two types of project descriptions.
One is for a library and the result
of the build will be a dll. This will contain classes and extension methods
(pretty much like "libbasic", "libtool", etc.).
<BR>
The other type is for applications, and the build will generate an installable executable (.exe file).
<P>
We usually define applications as a sub-project named "application",
and define all of the libraries as prerequisites.
You are not forced to do it like that - you can also put all of your classes into the application package,
and not use libraries at all. Or do a mix of both.
<BR>
In any case, you will need a special startup class - that is the class which will play the role
of the "main" function in a classic program. That's where the whole show starts later.
Two major things must be specified:
startup-className and startup-selector.



<H2><A NAME="CHCKIN_IN">Checking into the Source Repository</A></H2>

Next, check in all of your classes and the project definitions into the source code repository.
There are multiple ways to do this: by selecting the project and the project-lists popup menu,
or by selecting individual classes, and the class-list popup menu. If you use the class-list,
more work is to be done, to make sure that the extensions are also checked in (there is another item in the
class-lists repository menu, called "<VAR>Checkin Extensions for...</VAR>").

<H2><A NAME="BUILD_SUPPORT_FILES">Generating Build Support Files</A></H2>

In addition to the classes, you want ST/X to generate the build-support files.
These consist of Makefiles for both windows and linux systems, additional resource files
for the windows build, and batch scripts to start the build.
<P>
To have those files generated and also checked into the repository,
select the "<VAR>CheckIn Build-Support Files</VAR>" from the project-lists menu (with the project selected, of course).


<H2><A NAME="CHECKING_OUT">Checking Out</A></H2>

Now, it's time to open a terminal/console window (xterm or command-window),
move to your ST/X top installation directory (the one above the "stx"-directory),
and check out the project into your own project top.
<BR>
Initially, you will need a "cvs co" command, to get the tree (checkout).
<BR>
Later, a "cvs upd -d" will do, and only fetch the deltas (update).
<P>
After the checkout or update, you should see the following directory hierarchy:
<BLOCKQUOTE><PRE>
   stxXXX (where XXX is the ST/X release; currently 542)
      <B>theBiggerBugLTD</B>
	 <B>salesApp</B>
	    <B>startup</B>
	    <B>gui</B>
	    ...
      stx
	 ...
	 libbasic
</PRE></BLOCKQUOTE>
of course, the directory-names in the above example depend on how you named your
projects in the above "Specifying the Project's Hierarchy" step.
<P>
If you look at those directories in a filebrowser, explorer or K-Filelist, you should
see all of your classes as ".st" files, makefiles, a resource file for windows-building,
and a "bmake.bat" driver file.
All of them have been generated and checked in by the "<VAR>Generating Build Support Files</VAR>"
step above.


<H2><A NAME="BUILDING">Building</A></H2>

That is very easy:
<BR>
In a command window, enter that directory, and type:
<BLOCKQUOTE><PRE>
make  (unix/linux systems)
</PRE></BLOCKQUOTE>
or
<BLOCKQUOTE><PRE>
bmake  (msdos systems with borland compiler)
</PRE></BLOCKQUOTE>
or
<BLOCKQUOTE><PRE>
vcmake  (msdos systems with visual-C compiler)
</PRE></BLOCKQUOTE>

That's it; the result should be an executable.
For Win32 systems, if you have the nullsoft-install-system on your machine,
a self-extracting install-exe is also created, which is ready for deployment.
For Linux, an RPM packager is being developed and may be included in a future version
(for now, simply tar/zip the build-directory, and unpack it on the target machine).


<H2><A NAME="AUTOMATIC_BUILDING">Automatic Building</A></H2>

Using automatic build tools like jenkins (hudson),
you'd have to setup a CVS project, which checks out your module into a sibling folder
of the stx tree (i.e. install or copy the stx tree on the jenkins build machine.
Then, for a Unix build, enter the shell script:
<CODE><PRE>
    cd &lt;yourTop&gt;/&lt;yourModule&gt;/&lt;yourDirectory&gt;
    make
</PRE></CODE>
or, for a Windows build:
<CODE><PRE>
    cd &lt;yourTop&gt;\&lt;yourModule&gt;\&lt;yourDirectory&gt;
    bmake
</PRE></CODE>
with stx installed under "<CODE>&lt;yourTop&gt;/stx</CODE>".


<H2><A NAME="EXAMPLE">Concrete Examples</A></H2>

A concrete GUI demo is found in:
<BLOCKQUOTE><PRE>
clients/Demos/foxCalcApplication
</PRE></BLOCKQUOTE>

to see how an application definition and a startup-class for standalone startup looks,
load it and browse the code.

<P>
<P>
<HR>
Continue in <A HREF="tut_7b.html">"More Smalltalk"</A>.
<HR>
<P>
<IMG NOPRINT ALIGN=middle SRC="../../icons/stx.gif" ALT="[stx-logo]">
<BR>Copyright &copy; Claus Gittinger Development & Consulting
<BR>Copyright &copy; eXept Software AG
<P>
<ADDRESS>
<tt>&lt;<a href="mailto:cg@exept.de">cg@exept.de</a>&gt;</tt>
</ADDRESS>

<HR>
Doc $Revision: 1.13 $ $Date: 2015-11-20 03:37:50 $

</BODY>
</HTML>

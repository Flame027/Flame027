"{ NameSpace: Demos }"

ApplicationModel subclass:#Win32RegistryBrowser
	instanceVariableNames:''
	classVariableNames:''
	poolDictionaries:''
	category:'examples-Win32Registry'
!

TreeItem subclass:#TreeItemForKeys
	instanceVariableNames:''
	classVariableNames:''
	poolDictionaries:''
	privateIn:Demos::Win32RegistryBrowser
!


!Win32RegistryBrowser class methodsFor:'interface specs'!

windowSpec
    "This resource specification was automatically generated
     by the UIPainter of ST/X."

    "Do not manually edit this!! If it is corrupted,
     the UIPainter may not be able to read the specification."

    "
     UIPainter new openOnClass:CodingExamples::Win32RegistryBrowser andSelector:#windowSpec
     CodingExamples::Win32RegistryBrowser new openInterface:#windowSpec
     CodingExamples::Win32RegistryBrowser open
    "

    <resource: #canvas>

    ^
     #(#FullSpec
	#name: #windowSpec
	#window:
       #(#WindowSpec
	  #label: 'CodingExamples::Win32RegistryBrowser'
	  #name: 'CodingExamples::Win32RegistryBrowser'
	  #layout: #(#LayoutFrame 134 0 100 0 593 0 300 0)
	  #level: 0
	  #min: #(#Point 10 10)
	  #max: #(#Point 1024 768)
	  #bounds: #(#Rectangle 134 100 594 301)
	  #menu: #mainMenu
	  #usePreferredExtent: false
	  #returnIsOKInDialog: true
	  #escapeIsCancelInDialog: true
	)
	#component:
       #(#SpecCollection
	  #collection: #(
	   #(#VariableHorizontalPanelSpec
	      #name: 'VariableHorizontalPanel1'
	      #layout: #(#LayoutFrame 0 0.0 0 0.0 0 1.0 0 1.0)
	      #handles: #(#Any 0.5 1.0)
	      #component:
	     #(#SpecCollection
		#collection: #(
		 #(#SelectionInTreeViewSpec
		    #name: 'registryTreeList'
		    #model: #selectedRegistryItem
		    #hasHorizontalScrollBar: true
		    #hasVerticalScrollBar: true
		    #backgroundColor: #(#Color 100.0 100.0 100.0)
		    #showRoot: false
		    #showDirectoryIndicator: true
		    #valueChangeSelector: #keyItemSelected:
		    #hierarchicalList: #registryTree
		    #childrenSelector: #childrenOfKeyAction
		    #highlightMode: #label
		  )
		 #(#DataSetSpec
		    #name: 'registryValueTable'
		    #hasHorizontalScrollBar: true
		    #hasVerticalScrollBar: true
		    #dataList: #valueList
		    #has3Dsepartors: false
		    #columnHolder: #tableColumns
		  )
		 )

	      )
	    )
	   )

	)
      )
! !

!Win32RegistryBrowser class methodsFor:'menu specs'!

mainMenu
    "This resource specification was automatically generated
     by the MenuEditor of ST/X."

    "Do not manually edit this!! If it is corrupted,
     the MenuEditor may not be able to read the specification."

    "
     MenuEditor new openOnClass:CodingExamples::Win32RegistryBrowser andSelector:#mainMenu
     (Menu new fromLiteralArrayEncoding:(CodingExamples::Win32RegistryBrowser mainMenu)) startUp
    "

    <resource: #menu>

    ^
     #(#Menu
	#(
	 #(#MenuItem
	    #label: 'File'
	    #translateLabel: true
	    #submenu:
	   #(#Menu
	      #(
	       #(#MenuItem
		  #label: 'Exit'
		  #translateLabel: true
		  #value: #closeRequest
		)
	       )
	      nil
	      nil
	    )
	  )
	 #(#MenuItem
	    #label: 'Help'
	    #translateLabel: true
	    #startGroup: #right
	    #submenu:
	   #(#Menu
	      #(
	       #(#MenuItem
		  #label: 'About this Application'
		  #translateLabel: true
		  #value: #openAboutThisApplication
		)
	       )
	      nil
	      nil
	    )
	  )
	 )
	nil
	nil
      )
! !

!Win32RegistryBrowser class methodsFor:'tableColumns specs'!

tableColumns
    "This resource specification was automatically generated
     by the DataSetBuilder of ST/X."

    "Do not manually edit this!! If it is corrupted,
     the DataSetBuilder may not be able to read the specification."

    "
     DataSetBuilder new openOnClass:CodingExamples::Win32RegistryBrowser andSelector:#tableColumns
    "

    <resource: #tableColumns>

    ^#(
      #(#DataSetColumnSpec
	 #label: 'Name'
	 #id: ''
	 #model: #at:
	 #showRowSeparator: false
	 #showColSeparator: false
       )
      #(#DataSetColumnSpec
	 #label: 'Value'
	 #id: ''
	 #model: #at:
	 #showRowSeparator: false
	 #showColSeparator: false
       )
      )

! !

!Win32RegistryBrowser methodsFor:'aspects'!

registryTree
    "automatically generated by UIPainter ..."

    "*** the code below creates a default model when invoked."
    "*** (which may not be the one you wanted)"
    "*** Please change as required and accept in the browser."

    |holder|

    (holder := builder bindingAt:#registryRootItem) isNil ifTrue:[
	builder aspectAt:#registryRootItem put:(holder := SelectionInTree new).
    ].
    ^ holder.
!

selectedRegistryItem
    "automatically generated by UIPainter ..."

    "*** the code below creates a default model when invoked."
    "*** (which may not be the one you wanted)"
    "*** Please change as required and accept in the browser."

    |holder|

    (holder := builder bindingAt:#selectedRegistryItem) isNil ifTrue:[
	builder aspectAt:#selectedRegistryItem put:(holder :=  ValueHolder new).
    ].
    ^ holder.
!

tableColumns
    ^ self class tableColumns
!

valueList
    "automatically generated by UIPainter ..."

    "*** the code below creates a default model when invoked."
    "*** (which may not be the one you wanted)"
    "*** Please change as required and accept in the browser."

    |holder|

    (holder := builder bindingAt:#valueList) isNil ifTrue:[
	builder aspectAt:#valueList put:(holder :=  List new).
    ].
    ^ holder.
! !

!Win32RegistryBrowser methodsFor:'initialization & release'!

closeDownViews
    "This is a hook method generated by the Browser.
     It will be invoked when your app/dialog-window is really closed."

    "/ change the code below as required ...
    "/ This should cleanup any leftover resources
    "/ (for example, temporary files)
    "/ super closeRequest will initiate the closeDown

    "/ add your code here

    "/ do not remove the one below ...
    ^ super closeDownViews
!

initializeRegistryTree
    |treeView selInTree root|

"/    treeView := builder componentAt:#registryTreeList.
    selInTree := self registryTree.

    root := TreeItem new.
    selInTree root:root.

    Win32OperatingSystem::RegistryEntry rootKeyNames
    reverse do:[:aRootName |
	|item k|

	item := TreeItemForKeys new.
	item name:aRootName.
	item contents:aRootName.

	selInTree add:item below:root.
    ].


!

postBuildWith:aBuilder
    "This is a hook method generated by the Browser.
     It will be invoked during the initialization of your app/dialog,
     after all of the visual components have been built,
     but BEFORE the top window is made visible.
     Add any app-specific actions here (reading files, setting up
     values etc.)"

    "/ add any code here ...

    self initializeRegistryTree.
    ^ super postBuildWith:aBuilder

! !

!Win32RegistryBrowser methodsFor:'user interaction & notifications'!

childrenOfKeyAction
    ^ [:parent | self getChildrenOf:parent]
!

getChildrenOf:item
    |path parent k coll|

    path := item contents.

    path size == 0 ifTrue:[
	^ (Win32OperatingSystem::RegistryEntry rootKeyNames) collect:[:nm |
		|item|

		item := TreeItemForKeys new.
		item name:nm; contents:nm.
		item
	  ]
    ].

    k := Win32OperatingSystem::RegistryEntry key:path.
    k isNil ifTrue:[ ^ #() ].

    self withWaitCursorDo:[
	coll := OrderedCollection new.
	k subKeysDo:[:subKey |
	    coll add:(TreeItemForKeys
			    name:subKey name
			    contents:subKey path).
	].
	k close.
	coll sort:[:a :b | a name < b name].
    ].

    ^coll
!

keyItemSelected:index
    |sel key l valString|

    sel := self registryTree selectedNode.
    self valueList removeAll.
    sel notNil ifTrue:[
	key := Win32OperatingSystem::RegistryEntry key:(sel contents).
	key notNil ifTrue:[
	    l := OrderedCollection new.
	    key valueNamesAndValuesDo:[:nm :val |
		val isInteger ifTrue:[
		    valString := ' 0x' , (val hexPrintString leftPaddedTo:8 with:$0) , ' ' , val printString
		] ifFalse:[
		    valString := val storeString
		].
		l add:(Array with:nm with:valString).
	    ].
	    l sort:[:a :b | (a at:1) < (b at:1)].
	    self valueList addAll:l
	].
    ]
! !

!Win32RegistryBrowser::TreeItemForKeys methodsFor:'queries'!

hasChildren
    ^true
! !

!Win32RegistryBrowser class methodsFor:'documentation'!

version
    ^ '$Header: /cvs/stx/stx/clients/Demos/Win32RegistryBrowser.st,v 1.3 2009-10-10 06:10:08 cg Exp $'
! !
